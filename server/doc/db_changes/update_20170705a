# required for email notifications to participants, when kit is received and ddp setup
# updated w/ version
ALTER TABLE `ddp_instance`
CHANGE COLUMN `collaborator_id_prefix` `collaborator_id_prefix` VARCHAR(45) NULL DEFAULT NULL AFTER `bsp_organism`,
CHANGE COLUMN `is_active` `is_active` TINYINT(1) NOT NULL DEFAULT 0;

CREATE TABLE `EVENT_QUEUE` (
  `EVENT_ID` int(11) NOT NULL AUTO_INCREMENT,
  `EVENT_DATE_CREATED` bigint(20) NOT NULL,
  `EVENT_TYPE` varchar(50) NOT NULL,
  `DDP_INSTANCE_ID` int(15) NOT NULL,
  `DSM_KIT_REQUEST_ID` int(15) NOT NULL,
  PRIMARY KEY (`EVENT_ID`),
  KEY `FK_DDP_INSTANCE_ID_idx` (`DDP_INSTANCE_ID`),
  CONSTRAINT `FK_DDP_INSTANCE_ID` FOREIGN KEY (`DDP_INSTANCE_ID`) REFERENCES `ddp_instance` (`ddp_instance_id`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

ALTER TABLE `ddp_instance`
ADD COLUMN `reminder_notification_wks` int NULL DEFAULT NULL AFTER `collaborator_id_prefix`;


# required for participantExit
CREATE TABLE `ddp_participant_exit` (
  `ddp_participant_exit_id` int(15) NOT NULL AUTO_INCREMENT,
  `ddp_instance_id` int(15) NOT NULL,
  `ddp_participant_id` varchar(200) NOT NULL,
  `exit_date` bigint(20) NOT NULL,
  `exit_by` int(11) NOT NULL,
  PRIMARY KEY (`ddp_participant_exit_id`),
  KEY `participant_exit_user_fk_idx` (`exit_by`),
  KEY `participant_exit_instance_fk_idx` (`ddp_instance_id`),
  CONSTRAINT `participant_exit_instance_fk` FOREIGN KEY (`ddp_instance_id`) REFERENCES `ddp_instance` (`ddp_instance_id`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `participant_exit_user_fk` FOREIGN KEY (`exit_by`) REFERENCES `access_user` (`user_id`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

INSERT INTO `access_role` (`name`) VALUES ('participant_exit');


# required for deactivation of kit requests
ALTER TABLE `ddp_kit`
ADD COLUMN `deactivated_date` BIGINT(20) NULL DEFAULT NULL AFTER `easypost_address_id_to`,
ADD COLUMN `deactivation_reason` VARCHAR(500) NULL DEFAULT NULL AFTER `deactivated_date`;

ALTER TABLE `ddp_kit_request`
ADD COLUMN `created_by` VARCHAR(45) NULL DEFAULT NULL AFTER `ddp_label`;

ALTER TABLE `ddp_kit`
CHANGE COLUMN `message` `message` VARCHAR(500) NULL DEFAULT NULL ;

INSERT INTO `access_role` (`name`) VALUES ('kit_deactivation');

# required for refactoring
ALTER TABLE `bookmark`
CHANGE COLUMN `maxParticipantId` `value` INT(15) NOT NULL ,
CHANGE COLUMN `ddp_instance_id` `instance` VARCHAR(10) NOT NULL ;

INSERT INTO `bookmark` (`value`, `instance`) VALUES (1, 'bsp');


# required for ddp_instance table refactoring
# dropped by hand and not per script
# ALTER TABLE `ddp_instance`
# DROP COLUMN `easypost_api_key`,
# DROP COLUMN `has_mailing_list`,
# DROP COLUMN `has_additional_info_to_display`,
# DROP COLUMN `medical_record_activated`,
# DROP COLUMN `kit_request_activated`,
# DROP COLUMN `billing_reference`,
# DROP COLUMN `token_secret`;

CREATE TABLE `instance_role` (
  `instance_role_id` int(15) NOT NULL AUTO_INCREMENT,
  `name` varchar(45) NOT NULL,
  PRIMARY KEY (`instance_role_id`),
  UNIQUE KEY `name_UNIQUE` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

INSERT INTO `instance_role` (`name`) VALUES ('has_kit_request_endpoints');
INSERT INTO `instance_role` (`name`) VALUES ('kit_request_activated');
INSERT INTO `instance_role` (`name`) VALUES ('has_medical_record_endpoints');
INSERT INTO `instance_role` (`name`) VALUES ('medical_record_activated');
INSERT INTO `instance_role` (`name`) VALUES ('has_mailing_list_endpoint');
INSERT INTO `instance_role` (`name`) VALUES ('kit_participant_notifications_activated');
INSERT INTO `instance_role` (`name`) VALUES ('has_exit_participant_endpoint');

CREATE TABLE `ddp_instance_role` (
  `ddp_instance_role_id` int(15) NOT NULL AUTO_INCREMENT,
  `ddp_instance_id` int(15) NOT NULL,
  `instance_role_id` int(15) NOT NULL,
  PRIMARY KEY (`ddp_instance_role_id`),
  KEY `ddp_instance_role_fk_idx` (`instance_role_id`),
  KEY `ddp_instance_fk_idx` (`ddp_instance_id`),
  CONSTRAINT `ddp_instance_fk` FOREIGN KEY (`ddp_instance_id`) REFERENCES `ddp_instance` (`ddp_instance_id`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `ddp_instance_role_fk` FOREIGN KEY (`instance_role_id`) REFERENCES `instance_role` (`instance_role_id`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


# update of kits after migration
#BLOOD
UPDATE `prod_dsm_db`.`ddp_kit` SET `receive_date`='1497974400000' WHERE `dsm_kit_id`='221';
UPDATE `prod_dsm_db`.`ddp_kit` SET `receive_date`='1498665600000' WHERE `dsm_kit_id`='217';
#SALIVA
UPDATE `prod_dsm_db`.`ddp_kit` SET `receive_date`='1497888000000' WHERE `dsm_kit_id`='1339';
UPDATE `prod_dsm_db`.`ddp_kit` SET `receive_date`='1497888000000' WHERE `dsm_kit_id`='1756';
UPDATE `prod_dsm_db`.`ddp_kit` SET `receive_date`='1497888000000' WHERE `dsm_kit_id`='1909';
UPDATE `prod_dsm_db`.`ddp_kit` SET `receive_date`='1497888000000' WHERE `dsm_kit_id`='1950';
UPDATE `prod_dsm_db`.`ddp_kit` SET `receive_date`='1497888000000' WHERE `dsm_kit_id`='2043';
UPDATE `prod_dsm_db`.`ddp_kit` SET `receive_date`='1497888000000' WHERE `dsm_kit_id`='2044';
