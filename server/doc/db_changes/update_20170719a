# straighten user roles
UPDATE `access_role` SET `name`='mr_view' WHERE `name`='mr_admin';

# user settings
CREATE TABLE `user_settings` (
  `user_settings_id` int(15) NOT NULL AUTO_INCREMENT,
  `user_id` int(15) NOT NULL,
  `mr_rows_on_page` int(10) DEFAULT NULL,
  `mr_rows_set_0` int(10) DEFAULT NULL,
  `mr_rows_set_1` int(10) DEFAULT NULL,
  `mr_rows_set_2` int(10) DEFAULT NULL,
  `sample_rows_on_page` int(10) DEFAULT NULL,
  `sample_rows_set_0` int(10) DEFAULT NULL,
  `sample_rows_set_1` int(10) DEFAULT NULL,
  `sample_rows_set_2` int(10) DEFAULT NULL,
  `mailing_rows_on_page` int(10) DEFAULT NULL,
  `mailing_rows_set_0` int(10) DEFAULT NULL,
  `mailing_rows_set_1` int(10) DEFAULT NULL,
  `mailing_rows_set_2` int(10) DEFAULT NULL,
  PRIMARY KEY (`user_settings_id`),
  UNIQUE KEY `user_id_UNIQUE` (`user_id`),
  KEY `user_settings_user_fk_idx` (`user_id`),
  CONSTRAINT `user_settings_user_fk` FOREIGN KEY (`user_id`) REFERENCES `access_user` (`user_id`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

INSERT INTO user_settings (user_id) select user_id from access_user order by user_id;

# needed if another ddp gets connected
ALTER TABLE `ddp_participant`
DROP INDEX `ddp_participant_id_UNIQUE` ,
ADD UNIQUE INDEX `ddp_participant_id_UNIQUE` (`ddp_participant_id` ASC, `ddp_instance_id` ASC);

# blood kits
CREATE TABLE `ddp_kit_tracking` (
  `kit_tracking_id` int(11) NOT NULL AUTO_INCREMENT,
  `kit_label` varchar(255) NOT NULL,
  `tracking_id` varchar(255) NOT NULL,
  `scan_date` bigint(20) NOT NULL,
  PRIMARY KEY (`kit_tracking_id`),
  UNIQUE KEY `kit_label_UNIQUE` (`kit_label`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

# paper c/r
CREATE TABLE `ddp_participant_record` (
  `participant_record_id` int(15) NOT NULL AUTO_INCREMENT,
  `participant_id` int(15) NOT NULL,
  `cr_sent` varchar(45) DEFAULT NULL,
  `cr_received` varchar(45) DEFAULT NULL,
  `last_changed` bigint(20) NOT NULL,
  `changed_by` varchar(45) NOT NULL,
  PRIMARY KEY (`participant_record_id`),
  UNIQUE KEY `participant_id_UNIQUE` (`participant_id`),
  KEY `ddp_participant_record_participant_fk_idx` (`participant_id`),
  CONSTRAINT `ddp_participant_record_participant_fk` FOREIGN KEY (`participant_id`) REFERENCES `ddp_participant` (`participant_id`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

INSERT INTO ddp_participant_record (participant_id, last_changed, changed_by) select participant_id, UNIX_TIMESTAMP(NOW())*1000, "SYSTEM" from ddp_participant order by participant_id;

ALTER TABLE `ddp_onc_history`
ADD COLUMN `changed_by` VARCHAR(45) NOT NULL AFTER `last_changed`;

ALTER TABLE `ddp_medical_record`
ADD COLUMN `cr_required` TINYINT(1) NULL DEFAULT NULL AFTER `international`;
